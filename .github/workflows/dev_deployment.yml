name: 'Explorer Standalone Dev Deployment'

on:
  workflow_dispatch:
  push:
    branches: [dev, dev-deploy]

env:
  repo_name: camino-block-explorer-standalone
  repo: https://github.com/chain4travel/camino-block-explorer.git
  docker_image: 'europe-west3-docker.pkg.dev/pwk-c4t-dev/internal-camino-dev/camino-block-explorer'
  cloudrun_region: europe-west1

jobs:
  build_and_deploy:
    name: Build Docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          cache: yarn
          node-version: '18'

      - name: Set defaults
        id: setDefaults
        run: |
          export DATE=$(date '+%d_%m_%y')
          export BUILD_NUM=${{github.run_number}}
          export TAG="${GITHUB_REF##*/}_${DATE}_${BUILD_NUM}"
          echo "docker_image=${{ env.docker_image }}:$TAG" >> $GITHUB_OUTPUT

      - name: create docker image
        run: |
          docker build . -t ${{ steps.setDefaults.outputs.docker_image }}

      - name: Cloud authentication
        id: auth
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

      - name: push and deploy docker
        run: |
          gcloud auth configure-docker --quiet europe-west3-docker.pkg.dev
          docker push ${{ steps.setDefaults.outputs.docker_image }}
          gcloud run deploy ${{ env.repo_name }} --image ${{ steps.setDefaults.outputs.docker_image }} --region=${{ env.cloudrun_region }}
